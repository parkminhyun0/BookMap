<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“‘ BookMap ê´€ë¦¬ì í˜ì´ì§€</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4">ğŸ“‘ ê´€ë¦¬ì í˜ì´ì§€ (ìŠ¹ì¸ / ì‚­ì œ)</h2>
    <div id="loading" class="alert alert-info">â³ ë„ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
    <div id="admin-list"></div>
  </div>

  <script>
  const API_URL = "https://script.google.com/macros/s/AKfycbxFb7I_eFXm7nPtkcezalzNRSeJ3Pg5lPM6byRbiEHkF8pXVjReRC_kYKsVD0flABYrQw/exec";

  let booksData = [];

  // âœ… ë„ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadAdminBooks() {
    try {
      const res = await fetch(API_URL); // ëª¨ë“  ë„ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (ìŠ¹ì¸ ì—¬ë¶€ ê´€ê³„ì—†ì´)
      booksData = await res.json();

      document.getElementById("loading").style.display = "none";

      if (!Array.isArray(booksData) || booksData.length === 0) {
        document.getElementById("admin-list").innerHTML = `<div class="alert alert-warning">ë„ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      renderAdminList();
    } catch (err) {
      document.getElementById("loading").textContent = "âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err;
    }
  }

  // âœ… ê´€ë¦¬ì ëª©ë¡ ë Œë”ë§
  function renderAdminList() {
    const container = document.getElementById("admin-list");
    container.innerHTML = `
      <table class="table table-bordered table-striped bg-white">
        <thead>
          <tr>
            <th>#</th>
            <th>ì œëª©</th>
            <th>ì €ì</th>
            <th>ì¶œíŒì‚¬</th>
            <th>ìƒíƒœ</th>
            <th>ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody>
          ${booksData.map((b, i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${b.title || '-'}</td>
              <td>${b.author || '-'}</td>
              <td>${b.publisher || '-'}</td>
              <td>${b.status || 'ëŒ€ê¸°ì¤‘'}</td>
              <td>
                <button class="btn btn-sm btn-success me-2" onclick="approveBook(${i})">ìŠ¹ì¸</button>
                <button class="btn btn-sm btn-danger" onclick="deleteBook(${i})">ì‚­ì œ</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  // âœ… ìŠ¹ì¸ ê¸°ëŠ¥
  async function approveBook(index) {
    const book = booksData[index];
    if (!book) return alert("ë„ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

    if (!confirm(`"${book.title}" ë„ì„œë¥¼ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "update",
        id: index + 2, // ì‹œíŠ¸ì—ì„œ 2í–‰ë¶€í„° ë°ì´í„° ì‹œì‘
        patch: { status: "ìŠ¹ì¸" }
      })
    });

    const result = await res.json();
    if (result.ok) {
      alert("âœ… ìŠ¹ì¸ ì™„ë£Œ");
      loadAdminBooks();
    } else {
      alert("âŒ ìŠ¹ì¸ ì‹¤íŒ¨: " + result.error);
    }
  }

  // âœ… ì‚­ì œ ê¸°ëŠ¥
  async function deleteBook(index) {
    const book = booksData[index];
    if (!book) return alert("ë„ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

    if (!confirm(`"${book.title}" ë„ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "delete",
        id: index + 2 // ì‹œíŠ¸ì—ì„œ 2í–‰ë¶€í„° ë°ì´í„° ì‹œì‘
      })
    });

    const result = await res.json();
    if (result.ok) {
      alert("ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ");
      loadAdminBooks();
    } else {
      alert("âŒ ì‚­ì œ ì‹¤íŒ¨: " + result.error);
    }
  }

  loadAdminBooks();
  </script>
</body>
</html>
