<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>도서 목록</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4">📖 도서 목록</h2>

    <!-- 카테고리 버튼 영역 -->
    <div id="category-filters" class="mb-3"></div>
    <!-- 난이도 버튼 영역 -->
    <div id="level-filters" class="mb-4"></div>

    <!-- 로딩 안내 -->
    <div id="loading" class="text-muted">⏳ 로딩중...</div>

    <div id="book-list" class="row g-3"></div>

    <div class="mt-4">
      <a href="home.html" class="btn btn-secondary">⬅ 메인으로</a>
    </div>
  </div>

  <script>
  const API_URL = "YOUR_APPS_SCRIPT_URL"; // Apps Script WebApp URL
  let booksData = [];

  async function loadBooks() {
    document.getElementById("loading").style.display = "block";
    try {
      const res = await fetch(API_URL);
      let allBooks = await res.json();

      // ✅ 승인된 도서만 출력
      booksData = allBooks.filter(b => b.status === "승인");

      renderCategoryButtons(booksData);
      renderLevelButtons();
      renderBooks(booksData);
    } catch (err) {
      console.error(err);
      document.getElementById("loading").textContent = "❌ 데이터를 불러오지 못했습니다.";
    } finally {
      document.getElementById("loading").style.display = "none";
    }
  }

  function renderCategoryButtons(data) {
    const categories = new Set();
    data.forEach(b => {
      if (b.category) {
        b.category.split(",").map(c => c.trim()).forEach(c => categories.add(c));
      }
    });

    const container = document.getElementById("category-filters");
    container.innerHTML = `
      <button class="btn btn-secondary btn-sm me-2" onclick="filterBooks('','')">전체</button>
      ${[...categories].map(cat => `
        <button class="btn btn-outline-primary btn-sm me-2" onclick="filterBooks('${cat}','')">${cat}</button>
      `).join('')}
    `;
  }

  function renderLevelButtons() {
    const levels = ["전체","입문","초급","중급","고급","전문"];
    const container = document.getElementById("level-filters");
    container.innerHTML = levels.map(l => `
      <button class="btn btn-outline-success btn-sm me-2" onclick="filterBooks('', '${l}')">${l}</button>
    `).join('');
  }

  function renderBooks(data) {
    const container = document.getElementById("book-list");
    if (!data.length) {
      container.innerHTML = "<p class='text-muted'>등록된 도서가 없습니다.</p>";
      return;
    }

    container.innerHTML = data.map((b, i) => `
      <div class="col-md-6">
        <div class="card h-100 shadow-sm" onclick="openBook(${i})" style="cursor:pointer">
          <div class="row g-0">
            <div class="col-4">
              <img src="${b.cover || 'https://via.placeholder.com/120x180'}" class="img-fluid rounded-start" alt="${b.title}">
            </div>
            <div class="col-8">
              <div class="card-body">
                <h5 class="card-title">${b.title}</h5>
                <p class="card-text"><small class="text-muted">저자: ${b.author || '-'}</small></p>
                <p class="card-text"><small class="text-muted">난이도: ${b.level || '-'}</small></p>
                <p class="card-text text-truncate">${b.reason || ''}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }

  function filterBooks(category, level) {
    let filtered = [...booksData];
    if (category) filtered = filtered.filter(b => b.category && b.category.includes(category));
    if (level && level !== "전체") filtered = filtered.filter(b => b.level === level);
    renderBooks(filtered);
  }

  function openBook(index) {
    const book = booksData[index];
    localStorage.setItem("selectedBook", JSON.stringify(book));
    window.location.href = "books.html";
  }

  loadBooks();
  </script>
</body>
</html>
