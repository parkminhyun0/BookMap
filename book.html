<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“– BookMap - ìƒì„¸ í˜ì´ì§€</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#fafafa; }
    .container {
      max-width: 800px; margin: auto; padding: 20px;
      background: #fff; border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h1 { font-size: 24px; margin-bottom: 20px; }

    /* ğŸ”¹ í•„í„° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .filters { margin-bottom: 20px; }
    .filter-group { margin-bottom: 10px; }
    .filter-label { font-weight: bold; margin-right: 10px; }
    .filter-btn {
      display:inline-block; padding: 6px 12px; margin: 4px;
      border: 1px solid #ccc; border-radius: 6px;
      background:#f8f8f8; cursor: default;
      font-size: 14px; color:#555;
    }
    .filter-btn.active { background:#1a73e8; color:#fff; border-color:#1a73e8; }

    .row { display: flex; gap: 20px; flex-wrap: wrap; }
    .cover {
      width: 180px; height: 260px; object-fit: cover; border-radius: 6px;
      background: #f2f2f2; flex: 0 0 180px;
    }
    .info { flex: 1; }
    .meta { margin: 8px 0; font-size: 15px; color: #444; }
    .reason { margin-top: 15px; font-size: 16px; color:#222; line-height: 1.5; }
    .link { margin-top: 15px; display:inline-block; padding: 10px 16px;
      background:#1a73e8; color:#fff; border-radius: 6px; text-decoration:none; }
    .link:hover { background:#0c5fd1; }
    .back { margin-top: 25px; display:inline-block; font-size: 14px; color:#1a73e8; text-decoration:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“– ë„ì„œ ìƒì„¸</h1>

    <!-- ğŸ”¹ ìµœìƒë‹¨ í•„í„° í‘œì‹œ (ë‹¨ìˆœ í‘œì‹œìš©) -->
    <div class="filters">
      <div class="filter-group">
        <span class="filter-label">ğŸ“‚ ë¶„ì•¼:</span>
        <div id="category-filters"></div>
      </div>
      <div class="filter-group">
        <span class="filter-label">ğŸ“ˆ ë‚œì´ë„:</span>
        <div id="level-filters"></div>
      </div>
    </div>

    <div id="book-detail">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <a class="back" href="index.html">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxFb7I_eFXm7nPtkcezalzNRSeJ3Pg5lPM6byRbiEHkF8pXVjReRC_kYKsVD0flABYrQw/exec';

    // XSS ë°©ì§€
    const esc = (s) => String(s ?? '').replace(/[&<>"']/g, c => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));

    // URLì—ì„œ id íŒŒë¼ë¯¸í„° ì½ê¸°
    const params = new URLSearchParams(window.location.search);
    const bookId = params.get("id");

    async function loadBook() {
      const container = document.getElementById('book-detail');
      try {
        const res = await fetch(`${API_URL}?action=list&status=ìŠ¹ì¸`);
        const data = await res.json();

        if (!Array.isArray(data) || !data[bookId]) {
          container.textContent = "ë„ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }

        const book = data[bookId];

        // âœ… ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í‘œì‹œ
        const categoryFilters = document.getElementById("category-filters");
        categoryFilters.innerHTML = `<span class="filter-btn active">${esc(book.category || "ë¶„ì•¼ ì—†ìŒ")}</span>`;

        // âœ… ë‚œì´ë„ ë²„íŠ¼ í‘œì‹œ
        const levelFilters = document.getElementById("level-filters");
        const levels = ["ì…ë¬¸","ì´ˆê¸‰","ì¤‘ê¸‰","ê³ ê¸‰","ì „ë¬¸"];
        levelFilters.innerHTML = levels.map(l =>
          `<span class="filter-btn ${l === book.level ? "active" : ""}">${l}</span>`
        ).join("");

        // âœ… êµ¬ë§¤ì²˜ ì´ë¦„ ê°ì§€
        let storeName = "êµ¬ë§¤ì²˜";
        if (book.link) {
          if (book.link.includes("aladin")) storeName = "ì•Œë¼ë”˜";
          else if (book.link.includes("kyobo")) storeName = "êµë³´ë¬¸ê³ ";
          else if (book.link.includes("yes24")) storeName = "YES24";
          else if (book.link.includes("interpark")) storeName = "ì¸í„°íŒŒí¬ ë„ì„œ";
        }

        // âœ… ìƒì„¸ ë‚´ìš© ë Œë”ë§
        const coverHTML = book.cover
          ? `<img class="cover" src="${esc(book.cover)}" alt="${esc(book.title)} í‘œì§€" />`
          : `<div class="cover" style="display:flex;align-items:center;justify-content:center;color:#888;">í‘œì§€ ì—†ìŒ</div>`;

        container.innerHTML = `
          <div class="row">
            ${coverHTML}
            <div class="info">
              <h2>${esc(book.title)}</h2>
              <div class="meta"><b>ì €ì:</b> ${esc(book.author)}</div>
              <div class="meta"><b>ë¶„ì•¼:</b> ${esc(book.category)}</div>
              <div class="meta"><b>ë‚œì´ë„:</b> ${esc(book.level)}</div>
              <div class="reason">${book.reason ? esc(book.reason) : "ì„¤ëª… ì—†ìŒ"}</div>
              ${book.link ? `<a class="link" href="${esc(book.link)}" target="_blank">ğŸ”— ${storeName}ì—ì„œ ë³´ê¸°</a>` : ""}
            </div>
          </div>
        `;
      } catch (err) {
        container.textContent = "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err;
      }
    }

    loadBook();
  </script>
</body>
</html>
