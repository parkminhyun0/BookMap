<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë„ì„œ ëª©ë¡</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4">ğŸ“– ë„ì„œ ëª©ë¡</h2>

    <!-- ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì˜ì—­ -->
    <div id="category-filters" class="mb-3"></div>
    <!-- ë‚œì´ë„ ë²„íŠ¼ ì˜ì—­ -->
    <div id="level-filters" class="mb-4"></div>

    <!-- ë„ì„œ ëª©ë¡ -->
    <div id="book-list" class="row g-3 text-center">
      <div id="loading-msg" class="d-flex justify-content-center align-items-center w-100">
        <div class="spinner-border text-primary me-2" role="status"></div>
        <span class="text-muted">ë¡œë”©ì¤‘...</span>
      </div>
    </div>

    <div class="mt-4">
      <a href="index.html" class="btn btn-secondary">â¬… ë©”ì¸ìœ¼ë¡œ</a>
    </div>
  </div>

  <script>
  const API_URL = "https://script.google.com/macros/s/AKfycbxFb7I_eFXm7nPtkcezalzNRSeJ3Pg5lPM6byRbiEHkF8pXVjReRC_kYKsVD0flABYrQw/exec";
  let booksData = [];

  async function loadBooks() {
    const container = document.getElementById("book-list");
    const loadingMsg = document.getElementById("loading-msg");
    try {
      loadingMsg.style.display = "flex"; // ìŠ¤í”¼ë„ˆ í‘œì‹œ

      const res = await fetch(API_URL);
      booksData = await res.json();

      loadingMsg.style.display = "none"; // ë°ì´í„° ë„ì°© ì‹œ ìŠ¤í”¼ë„ˆ ì œê±°

      if (!Array.isArray(booksData) || booksData.length === 0) {
        container.innerHTML = `<p class="text-muted">ë“±ë¡ëœ ë„ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
        return;
      }

      renderCategoryButtons(booksData);
      renderLevelButtons();
      renderBooks(booksData);
    } catch (err) {
      loadingMsg.innerHTML = `<span class="text-danger">âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${err}</span>`;
    }
  }

  // âœ… ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ìë™ ìƒì„±
  function renderCategoryButtons(data) {
    const allCategories = data.flatMap(b => (b.category || "").split(",").map(c => c.trim()));
    const uniqueCategories = [...new Set(allCategories.filter(Boolean))];

    const container = document.getElementById("category-filters");
    container.innerHTML = `
      <button class="btn btn-secondary btn-sm me-2" onclick="filterBooks('','')">ì „ì²´</button>
      ${uniqueCategories.map(cat => `
        <button class="btn btn-outline-primary btn-sm me-2" onclick="filterBooks('${cat}','')">${cat}</button>
      `).join('')}
    `;
  }

  // âœ… ë‚œì´ë„ ë²„íŠ¼ ê³ ì •
  function renderLevelButtons() {
    const levels = ["ì „ì²´","ì…ë¬¸","ì´ˆê¸‰","ì¤‘ê¸‰","ê³ ê¸‰","ì „ë¬¸"];
    const container = document.getElementById("level-filters");
    container.innerHTML = levels.map(l => `
      <button class="btn btn-outline-success btn-sm me-2" onclick="filterBooks('', '${l}')">${l}</button>
    `).join('');
  }

  // âœ… ì¹´ë“œ ì¶œë ¥
  function renderBooks(data) {
    const container = document.getElementById("book-list");
    container.innerHTML = data.map((b, idx) => {
      const categories = (b.category || "").split(",").map(c => `<span class="badge bg-primary me-1">${c.trim()}</span>`).join(" ");
      return `
        <div class="col-md-6">
          <div class="card h-100 shadow-sm" onclick="goDetail(${idx})" style="cursor:pointer;">
            <div class="row g-0">
              <div class="col-4">
                <img src="${b.cover || 'https://via.placeholder.com/120x180'}" class="img-fluid rounded-start" alt="${b.title}">
              </div>
              <div class="col-8">
                <div class="card-body">
                  <h5 class="card-title">${b.title}</h5>
                  <p class="card-text"><small class="text-muted">ì €ì: ${b.author || '-'}</small></p>
                  <p class="card-text">${categories}</p>
                  <p class="card-text"><small class="text-muted">ë‚œì´ë„: ${b.level || '-'}</small></p>
                  <p class="card-text">${b.reason || ''}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // âœ… ìƒì„¸ í˜ì´ì§€ ì´ë™
  function goDetail(idx) {
    window.location.href = `books.html?id=${idx}`;
  }

  // âœ… í•„í„° ê¸°ëŠ¥
  function filterBooks(category, level) {
    let filtered = [...booksData];

    if (category) {
      filtered = filtered.filter(b => (b.category || "").split(",").map(c => c.trim()).includes(category));
    }
    if (level && level !== "ì „ì²´") {
      filtered = filtered.filter(b => b.level === level);
    }

    renderBooks(filtered);
  }

  loadBooks();
  </script>
</body>
</html>
